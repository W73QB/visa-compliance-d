<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Modern Compliance Checker</title>

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#137fec",
            "primary-hover": "#0f6bd0",
            "background-light": "#f6f7f8",
            "background-dark": "#101922",
            "surface-light": "#ffffff",
            "surface-dark": "#1a232e",
            "border-soft": "#e6e6e6",
            "border-dark": "#2d3748",
            "success-green": "#22c55e",
            "warning-yellow": "#eab308",
            "error-red": "#ef4444",
            "unknown-gray": "#6b7280",
            "info-blue": "#3b82f6",
            "text-primary": "#111418",
            "text-secondary": "#617589"
          },
          fontFamily: { "display": ["Inter", "sans-serif"] },
          borderRadius: {
            "DEFAULT": "0.5rem",
            "lg": "1rem",
            "xl": "1.5rem",
          },
        },
      },
    }
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0,'wght' 400,'GRAD' 0,'opsz' 24;
    }
    .icon-filled { font-variation-settings: 'FILL' 1,'wght' 400,'GRAD' 0,'opsz' 24; }
  </style>
</head>

<body class="bg-background-light dark:bg-background-dark min-h-screen font-display text-text-primary dark:text-white transition-colors duration-200">

<header class="sticky top-0 z-50 w-full bg-surface-light dark:bg-[#111418] border-b border-border-soft dark:border-border-dark backdrop-blur-md bg-opacity-95 dark:bg-opacity-95">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 h-16 flex items-center justify-between">
    <div class="flex items-center gap-2.5 hover:opacity-80 transition-opacity cursor-pointer">
      <span class="material-symbols-outlined text-primary text-3xl icon-filled">verified_user</span>
      <span class="text-text-primary dark:text-white text-xl font-bold tracking-tight">VisaCheck</span>
    </div>
    <nav class="hidden md:flex items-center gap-8">
      <a class="text-sm font-medium text-text-primary dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors" href="#">Home</a>
      <a class="text-sm font-medium text-text-primary dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors" href="#">Visas</a>
      <a class="text-sm font-medium text-text-primary dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors" href="#">Products</a>
      <a class="text-sm font-medium text-text-primary dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors" href="#">Official Sources</a>
      <a class="text-sm font-medium text-text-primary dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors" href="#">About</a>
    </nav>
    <button class="bg-primary hover:bg-primary-hover text-white text-sm font-semibold px-5 py-2.5 rounded-lg transition-all shadow-sm flex items-center gap-2">
      <span class="material-symbols-outlined text-sm">support_agent</span>
      Support
    </button>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 py-12">
  <div class="text-center mb-12">
    <h1 class="text-3xl md:text-5xl font-extrabold tracking-tight mb-4 text-text-primary dark:text-white">
      Insurance Compliance Checker
    </h1>
    <p class="text-text-secondary dark:text-gray-400 text-lg md:text-xl max-w-2xl mx-auto leading-relaxed">
      Ensure your insurance meets strict visa requirements with evidence-based results verified against official sources.
      <span class="block mt-2 text-sm">
        No source = UNKNOWN. Not legal advice.
      </span>
    </p>
  </div>

  <!-- INPUT CARD -->
  <div class="max-w-4xl mx-auto bg-surface-light dark:bg-surface-dark rounded-xl border border-border-soft dark:border-border-dark p-6 md:p-10 mb-12 shadow-sm">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">

      <div class="flex flex-col gap-3 group">
        <label class="text-xs font-bold text-text-secondary dark:text-gray-400 uppercase tracking-wider">I am applying for</label>
        <div class="relative">
          <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-primary transition-colors">gavel</span>
          <select id="visaSelect"
            class="w-full pl-12 pr-10 h-14 rounded-lg border border-border-soft dark:border-border-dark bg-white dark:bg-gray-800 text-text-primary dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all appearance-none cursor-pointer text-base font-medium shadow-sm hover:border-gray-300 dark:hover:border-gray-600">
            <option value="">Select visa route (authority)</option>
          </select>
          <span class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">expand_more</span>
        </div>
        <p id="visaHint" class="text-xs text-text-secondary dark:text-gray-500 pl-1">Choose a visa record (route + authority). Each record is evidence-based.</p>
      </div>

      <div class="flex flex-col gap-3 group">
        <label class="text-xs font-bold text-text-secondary dark:text-gray-400 uppercase tracking-wider">I want to use</label>
        <div class="relative">
          <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-primary transition-colors">health_and_safety</span>
          <select id="productSelect"
            class="w-full pl-12 pr-10 h-14 rounded-lg border border-border-soft dark:border-border-dark bg-white dark:bg-gray-800 text-text-primary dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all appearance-none cursor-pointer text-base font-medium shadow-sm hover:border-gray-300 dark:hover:border-gray-600">
            <option value="">Select an insurance product</option>
          </select>
          <span class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">expand_more</span>
        </div>
        <p id="productHint" class="text-xs text-text-secondary dark:text-gray-500 pl-1">Choose a product record (policy version + evidence).</p>
      </div>

    </div>

    <div class="mt-10 flex justify-center">
      <button id="checkBtn" disabled
        class="group flex items-center gap-3 px-8 py-3.5 bg-primary/50 text-white text-lg font-bold rounded-lg transition-all shadow-md cursor-not-allowed">
        <span class="material-symbols-outlined group-hover:scale-110 transition-transform">check_circle</span>
        Check Compliance
      </button>
    </div>
  </div>

  <!-- RESULT AREA -->
  <div id="resultArea" class="max-w-5xl mx-auto space-y-8 hidden">
    <div class="bg-surface-light dark:bg-surface-dark rounded-2xl border border-border-soft dark:border-border-dark overflow-hidden shadow-sm">

      <!-- Header -->
      <div class="p-8 border-b border-border-soft dark:border-border-dark bg-gradient-to-b from-transparent to-gray-50/50 dark:to-gray-900/30">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-6">

          <div class="flex flex-col gap-4">
            <div id="statusChip" class="inline-flex items-center gap-2 self-start px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider border">
              <span id="statusIcon" class="material-symbols-outlined text-sm icon-filled">help</span>
              <span id="statusChipText">UNKNOWN</span>
            </div>

            <div>
              <h2 id="resultTitle" class="text-3xl font-bold text-text-primary dark:text-white mb-2 flex items-center gap-3">
                Result: UNKNOWN
              </h2>
              <p id="resultSubtitle" class="text-text-secondary dark:text-gray-400">
                Cannot conclude due to missing evidence.
              </p>
            </div>
          </div>

          <div class="flex flex-col gap-2 text-sm text-text-secondary dark:text-gray-400 bg-white dark:bg-gray-800/50 p-4 rounded-lg border border-border-soft dark:border-border-dark">
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-gray-400 text-lg">history</span>
              <span class="font-medium">Last verified:</span>
              <span id="lastVerified">-</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-gray-400 text-lg">account_balance</span>
              <span class="font-medium">Authority:</span>
              <span id="authorityText">-</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-gray-400 text-lg">fingerprint</span>
              <span class="font-medium">Scope:</span>
              <span id="scopeText">-</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-gray-400 text-lg">inventory_2</span>
              <span class="font-medium">Snapshot:</span>
              <span id="snapshotId">-</span>
            </div>
          </div>

        </div>
      </div>

      <!-- Body -->
      <div class="grid grid-cols-1 lg:grid-cols-2 divide-y lg:divide-y-0 lg:divide-x divide-border-soft dark:divide-border-dark">
        <!-- Visa Requirements (FACTS) -->
        <div class="p-6 md:p-8">
          <div class="flex items-center gap-3 mb-6 pb-4 border-b border-border-soft dark:border-border-dark">
            <div class="p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
              <span class="material-symbols-outlined text-primary text-xl">rule</span>
            </div>
            <h3 class="font-bold text-lg text-text-primary dark:text-white">Visa Requirements (Facts)</h3>
          </div>

          <ul id="requirementsList" class="space-y-4"></ul>
        </div>

        <!-- Compliance Reasons (ENGINE) -->
        <div class="p-6 md:p-8 bg-gray-50/30 dark:bg-black/10">
          <div class="flex items-center gap-3 mb-6 pb-4 border-b border-border-soft dark:border-border-dark">
            <div class="p-2 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
              <span class="material-symbols-outlined text-purple-600 dark:text-purple-400 text-xl">fact_check</span>
            </div>
            <h3 class="font-bold text-lg text-text-primary dark:text-white">Compliance Reasons (Engine)</h3>
          </div>

          <ul id="reasonsList" class="space-y-4 relative">
            <div id="timelineLine" class="absolute left-[21px] top-6 bottom-6 w-0.5 bg-gray-200 dark:bg-gray-700 -z-10"></div>
          </ul>

          <!-- Missing evidence box (only when UNKNOWN) -->
          <div id="missingBox" class="mt-6 hidden">
            <div class="flex items-center gap-2 mb-2 text-text-primary dark:text-white">
              <span class="material-symbols-outlined text-warning-yellow">warning</span>
              <h4 class="font-bold">Missing evidence (why UNKNOWN)</h4>
            </div>
            <ul id="missingList" class="list-disc pl-6 text-sm text-text-secondary dark:text-gray-300"></ul>
          </div>
        </div>
      </div>

      <!-- Footer actions -->
      <div class="bg-gray-50 dark:bg-[#151c24] p-6 border-t border-border-soft dark:border-border-dark">
        <div class="flex flex-col md:flex-row items-center justify-between gap-4">
          <div class="flex flex-wrap gap-3 w-full md:w-auto justify-center md:justify-start">
            <a id="officialBtn" target="_blank" rel="noopener"
              class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-gray-800 border border-border-soft dark:border-border-dark hover:bg-gray-50 dark:hover:bg-gray-700 text-text-primary dark:text-white text-sm font-semibold rounded-lg transition-colors shadow-sm"
              href="#">
              <span class="material-symbols-outlined text-sm">open_in_new</span>
              Official Portal
            </a>

            <a id="snapshotBtn" target="_blank" rel="noopener"
              class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-gray-800 border border-border-soft dark:border-border-dark hover:bg-gray-50 dark:hover:bg-gray-700 text-text-primary dark:text-white text-sm font-semibold rounded-lg transition-colors shadow-sm"
              href="#">
              <span class="material-symbols-outlined text-sm">visibility</span>
              Open Snapshot
            </a>

            <a id="notifyBtn" target="_blank" rel="noopener"
              class="flex items-center gap-2 px-4 py-2 bg-primary hover:bg-primary-hover text-white text-sm font-semibold rounded-lg transition-colors shadow-sm"
              href="#">
              <span class="material-symbols-outlined text-sm">notifications_active</span>
              Notify me of changes
            </a>
          </div>

          <button id="copyLinkBtn"
            class="flex items-center gap-2 px-4 py-2 text-text-secondary hover:text-primary dark:text-gray-400 dark:hover:text-white text-sm font-medium transition-colors">
            <span class="material-symbols-outlined text-lg">link</span>
            Copy link
          </button>
        </div>


        <div id="offerCta" class="mt-6 hidden">
          <div class="p-4 rounded-lg border border-border-soft dark:border-border-dark bg-white dark:bg-gray-800">
            <div id="offerMessage" class="text-sm text-text-primary dark:text-white font-semibold"></div>
            <a id="offerLink" class="mt-3 inline-flex items-center gap-2 px-4 py-2 bg-primary hover:bg-primary-hover text-white text-sm font-semibold rounded-lg" target="_blank" rel="noopener" href="#">Get quote</a>
            <div id="offerDisclosure" class="mt-2 text-xs text-text-secondary dark:text-gray-400">Affiliate link.</div>
          </div>
        </div>

        <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-800 flex justify-between text-xs text-gray-400">
          <div class="flex items-center gap-1">
            <span class="material-symbols-outlined text-sm">update</span>
            <span id="lastUpdated">Last updated: -</span>
          </div>
          <div class="flex items-center gap-1">
            <span class="material-symbols-outlined text-sm">code</span>
            <span id="builtAt">Built at: -</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal evidence -->
  <div id="modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
    <div class="w-full max-w-3xl bg-white dark:bg-[#111418] rounded-xl border border-border-soft dark:border-border-dark shadow-lg">
      <div class="flex items-center justify-between p-4 border-b border-border-soft dark:border-border-dark">
        <div class="font-bold text-text-primary dark:text-white">Evidence</div>
        <button id="closeModal"
          class="px-3 py-2 text-sm font-semibold border border-border-soft dark:border-border-dark rounded-lg bg-white dark:bg-gray-800 text-text-primary dark:text-white hover:bg-gray-50 dark:hover:bg-gray-700 transition">
          Close
        </button>
      </div>
      <div id="modalBody" class="p-4 space-y-4 max-h-[70vh] overflow-auto"></div>
    </div>
  </div>

</main>

<footer class="bg-surface-light dark:bg-[#0d1117] border-t border-border-soft dark:border-border-dark mt-12">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 py-12">
    <div class="flex flex-col md:flex-row justify-between items-center gap-8">
      <div class="flex items-center gap-2 opacity-80">
        <span class="material-symbols-outlined text-2xl text-primary icon-filled">verified_user</span>
        <span class="font-bold text-lg text-text-primary dark:text-white">VisaCheck</span>
      </div>
      <div class="flex flex-wrap justify-center gap-8 text-sm font-medium text-text-secondary dark:text-gray-400">
        <a class="hover:text-primary transition-colors" href="../methodology/">Methodology</a>
        <a class="hover:text-primary transition-colors" href="../disclaimer/">Disclaimer</a>
        <a class="hover:text-primary transition-colors" href="../affiliate-disclosure/">Affiliate Disclosure</a>
      </div>
      <p class="text-xs text-text-secondary dark:text-gray-600">(c) 2024 VisaCheck Inc. All rights reserved.</p>
    </div>
  </div>
</footer>

<script>
/*
  Resolve the data URL based on the page location:
  - /ui/index.html -> "../data/ui_index.json"
  - /index.html -> "data/ui_index.json"
  With snapshot param:
  - /ui/?snapshot=foo -> "../snapshots/foo/ui_index.json"
*/
const SNAPSHOT_PARAM = new URLSearchParams(location.search).get("snapshot");

function resolveDataUrl(pathname, snapshot) {
  const path = String(pathname || "").replace(/\/g, "/");
  const safeSnapshot = snapshot ? snapshot.replace(/^\/+/, "") : "";
  if (safeSnapshot) {
    if (path.endsWith("/ui/index.html") || path.endsWith("/ui/")) {
      return "../snapshots/" + safeSnapshot + "/ui_index.json";
    }
    return "snapshots/" + safeSnapshot + "/ui_index.json";
  }
  if (path.endsWith("/ui/index.html") || path.endsWith("/ui/")) {
    return "../data/ui_index.json";
  }
  return "data/ui_index.json";
}

const DATA_URL = resolveDataUrl(location.pathname, SNAPSHOT_PARAM);


// Used by "Notify me of changes" to create a GitHub issue
const GITHUB_OWNER = "W73QB";
const GITHUB_REPO  = "visa-compliance-d";

// Optional display labels for requirement keys (fallback to raw key if missing)
const REQ_LABELS = {
  "insurance.mandatory": { title: "Insurance required", desc: "Insurance must be provided." },
  "insurance.authorized_in_spain": { title: "Authorized to operate in Spain", desc: "Insurer must be authorized to operate in Spain." },
  "insurance.covers_public_health_system_risks": { title: "Equivalent to public system", desc: "Must cover risks insured by Spain's public health system." },
  "insurance.comprehensive": { title: "Comprehensive coverage", desc: "Coverage must be comprehensive as required by authority." },
  "insurance.unlimited_coverage": { title: "Unlimited coverage", desc: "Unlimited coverage required." },
  "insurance.no_deductible": { title: "No deductible / excess", desc: "Must have zero deductible / no excess." },
  "insurance.no_copayment": { title: "No co-payments", desc: "Must not require co-payments." },
  "insurance.no_moratorium": { title: "No moratorium / waiting period", desc: "No waiting period or moratorium." },
  "insurance.travel_insurance_accepted": { title: "Travel insurance accepted", desc: "Whether travel insurance is accepted." },
  "insurance.min_coverage": { title: "Minimum coverage", desc: "Minimum required medical coverage." },
  "insurance.must_cover_full_period": { title: "Must cover full legal stay", desc: "Policy duration must cover the entire authorized stay." },
  "insurance.monthly_payments_accepted": { title: "Monthly payments accepted", desc: "Whether monthly payment policies are acceptable." }
};

function $(id){ return document.getElementById(id); }
function escapeHtml(value){
  return String(value)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/\"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

function sanitizeUrl(url) {
  if (!url) return "";
  const s = String(url).trim();
  // Allow http://, https://, mailto:, tel:
  if (/^(?:https?|mailto|tel):/i.test(s)) return s;
  // Allow relative paths (starting with / or . or just alphanumeric)
  // BUT we must be careful not to allow "javascript:" which can be relative if base tag is manipulated,
  // though in this context it's safer.
  // We explicitly verify it doesn't start with javascript: or vbscript: or data:
  if (/^(?:javascript|vbscript|data):/i.test(s)) return "#";
  return s;
}

let INDEX = null;

// Supports both ui_index.json shapes:
// 1) denormalized: visas_by_id/products_by_id/mappings_by_key/sources_by_id
// 2) arrays: visas/products/mappings
function normalizeIndex(raw){
  const visas = raw.visas || [];
  const products = raw.products || [];
  const mappings = raw.mappings || [];
  const offers = raw.offers || [];

  const visa_list = raw.visa_list || visas.map(v => ({ id:v.id, country:v.country, visa_name:v.visa_name, route:v.route }));
  const product_list = raw.product_list || products.map(p => ({ id:p.id, provider:p.provider, product_name:p.product_name }));

  const visas_by_id = raw.visas_by_id || Object.fromEntries(visas.map(v => [v.id, v]));
  const products_by_id = raw.products_by_id || Object.fromEntries(products.map(p => [p.id, p]));

  const sources_by_id = raw.sources_by_id || (() => {
    const m = {};
    visas.forEach(v => (v.sources || []).forEach(s => m[s.source_id] = s));
    return m;
  })();

  const offers_by_product = raw.offers_by_product || (() => {
    const m = {};
    offers.forEach(o => { if (o.product_id) m[o.product_id] = o; });
    return m;
  })();

  const mappings_by_key = raw.mappings_by_key || (() => {
    const m = {};
    mappings.forEach(x => m[`${x.visa_id}__${x.product_id}`] = x);
    return m;
  })();

  return {
    built_at: raw.built_at || null,
    snapshot_id: raw.snapshot_id || null,
    visa_list, product_list,
    visas_by_id, products_by_id,
    sources_by_id, mappings_by_key,
    offers_by_product
  };
}

function setCheckBtnEnabled(){
  const ok = $("visaSelect").value && $("productSelect").value;
  const btn = $("checkBtn");
  btn.disabled = !ok;
  btn.className = ok
    ? "group flex items-center gap-3 px-8 py-3.5 bg-primary hover:bg-primary-hover text-white text-lg font-bold rounded-lg transition-all shadow-md hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0"
    : "group flex items-center gap-3 px-8 py-3.5 bg-primary/50 text-white text-lg font-bold rounded-lg transition-all shadow-md cursor-not-allowed";
}

function relativeTime(iso){
  if (!iso) return "-";
  const t = Date.parse(iso);
  if (Number.isNaN(t)) return iso;
  const diff = Date.now() - t;
  const mins = Math.floor(diff/60000);
  if (mins < 1) return "just now";
  if (mins < 60) return `${mins} minutes ago`;
  const hrs = Math.floor(mins/60);
  if (hrs < 48) return `${hrs} hours ago`;
  const days = Math.floor(hrs/24);
  return `${days} days ago`;
}

function statusPresentation(status){
  const s = (status || "UNKNOWN").toUpperCase();
  if (s === "GREEN") {
    return {
      chipText: "PASSED",
      chipClass: "bg-success-green/10 border-success-green/20 text-success-green",
      icon: "verified",
      title: "Result: PASS (Status: GREEN)",
      subtitle: "Meets the listed requirements based on available evidence."
    };
  }
  if (s === "YELLOW") {
    return {
      chipText: "CAUTION",
      chipClass: "bg-warning-yellow/10 border-warning-yellow/20 text-warning-yellow",
      icon: "warning",
      title: "Result: CAUTION (Status: YELLOW)",
      subtitle: "Meets hard requirements, but there is an edge-case / operational risk."
    };
  }
  if (s === "RED") {
    return {
      chipText: "FAILED",
      chipClass: "bg-error-red/10 border-error-red/20 text-error-red",
      icon: "cancel",
      title: "Result: FAIL (Status: RED)",
      subtitle: "Violates at least one explicit requirement."
    };
  }
  if (s === "NOT_REQUIRED") {
    return {
      chipText: "NOT REQUIRED",
      chipClass: "bg-info-blue/10 border-info-blue/20 text-info-blue",
      icon: "info",
      title: "Result: NOT REQUIRED (Status: NOT_REQUIRED)",
      subtitle: "Insurance is not listed as a requirement by the authority."
    };
  }
  return {
    chipText: "UNKNOWN",
    chipClass: "bg-gray-200/40 border-gray-300 text-unknown-gray dark:bg-gray-700/30 dark:border-gray-600",
    icon: "help",
    title: "Result: UNKNOWN (Missing evidence)",
    subtitle: "Cannot conclude due to missing evidence."
  };
}

function openModal(evidenceItems){
  const body = $("modalBody");
  body.innerHTML = "";

  (evidenceItems || []).forEach(ev => {
    const sid = ev.source_id;
    const src = INDEX.sources_by_id[sid] || {};
    const official = sanitizeUrl(src.url || ev.url || "");
    const snapshot = src.local_path
      ? ("../" + src.local_path.replaceAll("\\","/"))
      : (ev.local_path ? ("../" + ev.local_path.replaceAll("\\","/")) : "");

    // snapshot is relative path constructed by us, but we should be safe.
    // However, if local_path is malicious, we should sanitize it too if possible,
    // but the prefix "../" makes it relative.

    const sidText = escapeHtml(sid || "source");
    const locatorText = escapeHtml(ev.locator || "");
    const excerptText = escapeHtml(ev.excerpt || "");
    const syntheticLabel = src.synthetic ? "<span class=\"ml-2 text-xs font-semibold text-warning-yellow\">Synthetic source</span>" : "";

    const card = document.createElement("div");
    card.className = "border border-border-soft dark:border-border-dark rounded-lg p-4 bg-white dark:bg-surface-dark";

    card.innerHTML = `
      <div class="text-sm font-semibold text-text-primary dark:text-white mb-1">
        ${sidText} - ${locatorText} ${syntheticLabel}
      </div>
      <pre class="text-sm text-text-secondary dark:text-gray-200 whitespace-pre-wrap break-words">${excerptText}</pre>
      <div class="mt-3 text-xs text-text-secondary dark:text-gray-400 flex gap-4">
        ${official ? `<a class="hover:text-primary underline" target="_blank" rel="noopener" href="${escapeHtml(official)}">official</a>` : ""}
        ${snapshot ? `<a class="hover:text-primary underline" target="_blank" rel="noopener" href="${escapeHtml(snapshot)}">snapshot</a>` : ""}
      </div>
    `;
    body.appendChild(card);
  });

  $("modal").classList.remove("hidden");
  $("modal").classList.add("flex");
}

function closeModal(){
  $("modal").classList.add("hidden");
  $("modal").classList.remove("flex");
}

function renderRequirements(visa){
  const ul = $("requirementsList");
  ul.innerHTML = "";

  const reqs = visa?.requirements || [];
  if (!reqs.length){
    ul.innerHTML = `<li class="text-sm text-text-secondary dark:text-gray-400">No requirements loaded.</li>`;
    return;
  }

  reqs.forEach(r => {
    const meta = REQ_LABELS[r.key] || { title: r.key, desc: "" };
    const title = escapeHtml(meta.title);
    const desc = escapeHtml(meta.desc || "");
    const valueText = escapeHtml(String(r.value));

    const li = document.createElement("li");
    li.className = "p-4 rounded-xl border border-transparent hover:border-border-soft dark:hover:border-border-dark hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors group";

    // SEMANTICS: Requirements are FACTS, not "passed".
    li.innerHTML = `
      <div class="flex items-start justify-between gap-4">
        <div class="flex items-start gap-3">
          <span class="material-symbols-outlined text-primary text-xl mt-0.5 shrink-0">rule</span>
          <div>
            <p class="text-sm font-semibold text-text-primary dark:text-white">${title}</p>
            <p class="text-xs text-text-secondary dark:text-gray-500 mt-1">${desc}</p>
            <p class="text-xs text-text-secondary dark:text-gray-500 mt-1">
              <span class="font-bold">Value:</span> ${valueText}
            </p>
          </div>
        </div>
        <button class="evBtn opacity-0 group-hover:opacity-100 focus:opacity-100 flex items-center gap-1 text-xs font-semibold text-primary hover:text-primary-hover transition-all">
          View Evidence
          <span class="material-symbols-outlined text-sm">arrow_forward</span>
        </button>
      </div>
    `;

    li.querySelector(".evBtn").addEventListener("click", () => openModal(r.evidence || []));
    ul.appendChild(li);
  });
}

function renderReasons(mapping){
  const ul = $("reasonsList");
  // Keep the timeline line (absolute div) at the top
  ul.innerHTML = `<div id="timelineLine" class="absolute left-[21px] top-6 bottom-6 w-0.5 bg-gray-200 dark:bg-gray-700 -z-10"></div>`;

  if (!mapping){
    const li = document.createElement("li");
    li.className = "text-sm text-text-secondary dark:text-gray-300";
    li.textContent = "No mapping found for this visa/product. Run tools/build_mappings.py and rebuild ui_index.json.";
    ul.appendChild(li);
    return;
  }

  const status = (mapping.status || "UNKNOWN").toUpperCase();
  const dotColor =
    status === "GREEN" ? "bg-success-green" :
    status === "YELLOW" ? "bg-warning-yellow" :
    status === "RED" ? "bg-error-red" :
    status === "NOT_REQUIRED" ? "bg-info-blue" :
    "bg-gray-400";

  const reasons = mapping.reasons || [];
  if (!reasons.length){
    const li = document.createElement("li");
    li.className = "text-sm text-text-secondary dark:text-gray-300";
    li.textContent =
      status === "NOT_REQUIRED" ? "Insurance is not listed as a requirement by the authority." :
      status === "UNKNOWN" ? "Engine cannot conclude due to missing evidence." :
      status === "GREEN" ? "Engine found no rule violations based on available evidence." :
      status === "YELLOW" ? "Engine found an edge-case / operational risk." :
      "Engine found explicit rule violation(s).";
    ul.appendChild(li);
    return;
  }

  reasons.forEach(r => {
    const reasonText = escapeHtml(r.text || "");
    const li = document.createElement("li");
    li.className = "flex gap-4";

    li.innerHTML = `
      <div class="mt-1 size-3 rounded-full ${dotColor} ring-4 ring-white dark:ring-[#1a232e]"></div>
      <div class="flex-1 pb-4">
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-border-soft dark:border-border-dark shadow-sm">
          <p class="text-sm text-text-primary dark:text-gray-200 leading-relaxed mb-3">
            ${reasonText}
          </p>
          <button class="evBtn text-xs font-medium text-text-secondary hover:text-primary flex items-center gap-1 transition-colors">
            <span class="material-symbols-outlined text-sm">open_in_new</span>
            View Evidence
          </button>
        </div>
      </div>
    `;

    li.querySelector(".evBtn").addEventListener("click", () => openModal(r.evidence || []));
    ul.appendChild(li);
  });
}

function renderOffer(mapping, productId){
  const status = (mapping?.status || "UNKNOWN").toUpperCase();
  const offer = INDEX.offers_by_product ? INDEX.offers_by_product[productId] : null;

  const box = $("offerCta");
  const message = $("offerMessage");
  const link = $("offerLink");
  const disclosure = $("offerDisclosure");

  box.classList.add("hidden");
  link.href = "#";
  link.classList.remove("hidden");

  if (status === "RED" || status === "UNKNOWN") return;
  if (status === "NOT_REQUIRED") {
    message.textContent = "Insurance is optional for this visa.";
    disclosure.textContent = "No affiliate link shown.";
    link.classList.add("hidden");
    box.classList.remove("hidden");
    return;
  }
  if (!offer) return;

  link.textContent = offer.label || "Get quote";
  link.href = offer.affiliate_url;
  disclosure.textContent = offer.disclosure || "Affiliate link. Results are evidence-based.";

  if (status === "YELLOW") {
    message.textContent = "Caution: operational risk. Affiliate link shown for convenience.";
  } else {
    message.textContent = "Meets listed requirements based on evidence.";
  }

  box.classList.remove("hidden");
}

function renderMissing(mapping){
  const missing = mapping?.missing || mapping?.missing_evidence || [];
  if (missing.length) {
    $("missingBox").classList.remove("hidden");
    const ul = $("missingList");
    ul.innerHTML = "";
    missing.forEach(m => {
      const li = document.createElement("li");
      li.textContent = m;
      ul.appendChild(li);
    });
  } else {
    $("missingBox").classList.add("hidden");
    $("missingList").innerHTML = "";
  }
}

function updateHints(){
  const visaId = $("visaSelect").value;
  const productId = $("productSelect").value;

  const visa = INDEX.visas_by_id[visaId];
  const prod = INDEX.products_by_id[productId];

  $("visaHint").textContent = visa
    ? `${visa.authority} - ${visa.route} - last_verified: ${visa.last_verified}`
    : "Choose a visa record (route + authority). Each record is evidence-based.";

  $("productHint").textContent = prod
    ? `${prod.provider} - policy_version: ${prod.policy_version} - effective: ${prod.effective_date}`
    : "Choose a product record (policy version + evidence).";

  setCheckBtnEnabled();
}

function renderResult(){
  const visaId = $("visaSelect").value;
  const productId = $("productSelect").value;

  const visa = INDEX.visas_by_id[visaId];
  const prod = INDEX.products_by_id[productId];
  if (!visa || !prod) return;

  const key = `${visaId}__${productId}`;
  const mapping = INDEX.mappings_by_key[key] || null;
  const status = (mapping?.status || "UNKNOWN").toUpperCase();

  const pres = statusPresentation(status);

  // show container
  $("resultArea").classList.remove("hidden");

  // chip + title/subtitle
  $("statusChip").className = `inline-flex items-center gap-2 self-start px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider border ${pres.chipClass}`;
  $("statusIcon").textContent = pres.icon;
  $("statusChipText").textContent = pres.chipText;
  $("resultTitle").textContent = pres.title;
  $("resultSubtitle").textContent = pres.subtitle;

  // meta
  $("lastVerified").textContent = visa.last_verified || "-";
  $("authorityText").textContent = visa.authority || "-";
  $("scopeText").textContent = visa.id || "-";
  $("snapshotId").textContent = SNAPSHOT_PARAM || INDEX.snapshot_id || "-";

  // requirements + reasons
  renderRequirements(visa);
  renderReasons(mapping);
  renderOffer(mapping, productId);

  // missing box only meaningful for UNKNOWN
  if (status === "UNKNOWN") renderMissing(mapping);
  else {
    $("missingBox").classList.add("hidden");
    $("missingList").innerHTML = "";
  }

  // action links
  const firstSource = (visa.sources && visa.sources.length) ? visa.sources[0] : null;
  $("officialBtn").href = sanitizeUrl(firstSource?.url || "#");
  $("snapshotBtn").href = firstSource?.local_path ? ("../" + firstSource.local_path.replaceAll("\\","/")) : "#";

  // notify issue
  const issueTitle = encodeURIComponent(`Source change - ${visa.id}`);
  const issueBody = encodeURIComponent(
    `Please review sources for ${visa.id}\n\n` +
    `source_id(s): ${(visa.sources||[]).map(s=>s.source_id).join(", ")}\n\n` +
    `What changed:\n- \n`
  );
  $("notifyBtn").href = `https://github.com/${GITHUB_OWNER}/${GITHUB_REPO}/issues/new?title=${issueTitle}&body=${issueBody}`;

  // built timestamps
  const builtAt = INDEX.built_at || "";
  $("builtAt").textContent = builtAt ? `Built at: ${builtAt}` : "Built at: -";
  $("lastUpdated").textContent = builtAt ? `Last updated: ${relativeTime(builtAt)}` : "Last updated: -";

  // deep link
  const url = new URL(location.href);
  url.searchParams.set("visa", visaId);
  url.searchParams.set("product", productId);
  if (SNAPSHOT_PARAM) url.searchParams.set("snapshot", SNAPSHOT_PARAM);
  history.replaceState(null, "", url.toString());
}

async function init(){
  const res = await fetch(DATA_URL, { cache: "no-store" });
  const raw = await res.json();
  INDEX = normalizeIndex(raw);

  // populate selects
  const vs = $("visaSelect");
  INDEX.visa_list.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v.id;
    opt.textContent = `${v.country} - ${v.visa_name} (${v.route})`;
    vs.appendChild(opt);
  });

  const ps = $("productSelect");
  INDEX.product_list.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = `${p.provider} - ${p.product_name}`;
    ps.appendChild(opt);
  });

  // restore from query
  const q = new URLSearchParams(location.search);
  const v0 = q.get("visa");
  const p0 = q.get("product");
  if (v0 && INDEX.visas_by_id[v0]) vs.value = v0;
  if (p0 && INDEX.products_by_id[p0]) ps.value = p0;

  // listeners
  vs.addEventListener("change", updateHints);
  ps.addEventListener("change", updateHints);

  $("checkBtn").addEventListener("click", (e) => {
    e.preventDefault();
    renderResult();
  });

  $("copyLinkBtn").addEventListener("click", async () => {
    await navigator.clipboard.writeText(location.href);
    $("copyLinkBtn").innerHTML = `<span class="material-symbols-outlined text-lg">done</span> Copied`;
    setTimeout(() => {
      $("copyLinkBtn").innerHTML = `<span class="material-symbols-outlined text-lg">link</span> Copy link`;
    }, 900);
  });

  $("closeModal").addEventListener("click", closeModal);
  $("modal").addEventListener("click", (e) => { if (e.target.id === "modal") closeModal(); });

  updateHints();

  // auto-run if query has both
  if (vs.value && ps.value) {
    setCheckBtnEnabled();
    renderResult();
  }
}

init().catch(err => {
  console.error(err);
  alert("Failed to load data/ui_index.json. Check DATA_URL and ensure ui_index.json exists.");
});
</script>

</body>
</html>
