# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

A compliance-first visa insurance platform that compares official visa requirements (VisaFacts) against insurance product specifications (ProductFacts) using an automated rule engine (Mappings). Hugo static site with PaperMod theme.

**Core principle:** Everything backed by primary sources. No source = UNKNOWN. UNKNOWN > Wrong.

## Build Commands

```bash
# Validate all JSON data against schemas
py tools/validate.py

# Build compliance mappings (visa × product → status)
py tools/build_mappings.py

# Build UI index (data/ui_index.json)
py tools/build_index.py

# Sync UI/data/sources into static/ for Hugo
py tools/sync_hugo_static.py

# Lint blog content (posts/visas/guides/traps sections only)
py tools/lint_content.py

# Run local Hugo server
hugo server -D

# Create daily snapshot
py tools/build_snapshot.py

# Create release snapshot
py tools/build_release_snapshot.py --release-id YYYY-MM-DD
```

## Testing

Tests are PowerShell scripts in `tools/tests/`:
```bash
powershell -NoProfile -File tools/tests/ui_compliance_tests.ps1
powershell -NoProfile -File tools/tests/validate_product_sources_tests.ps1
powershell -NoProfile -File tools/tests/snapshot_tests.ps1
```

Run single file validation:
```bash
py tools/validate.py --visa path/to/visa_facts.json
py tools/validate.py --product path/to/product_facts.json
```

## Architecture

### Data Layer (`data/`)
- `visas/{COUNTRY}/{VISA_TYPE}/{authority}/{date}/visa_facts.json` - Official requirements with evidence
- `products/{Provider}/{Product}/{date}/product_facts.json` - Insurance specs with evidence
- `mappings/{VISA_ID}__{PRODUCT_ID}.json` - Generated compliance results (GREEN/YELLOW/RED/UNKNOWN/NOT_REQUIRED)
- `ui_index.json` - Aggregated index consumed by UI (generated)
- `offers/offers.json` - Affiliate offers (language validated for banned words)

### Sources Layer (`sources/`)
Evidence files (PDFs, etc.) with companion `*.meta.json` containing:
- `source_id` - Unique identifier referenced in visa/product JSON
- `sha256` - Hash of the evidence file (validated by `tools/validate.py`)
- `local_path` - Relative path to the actual file

### Rule Engine (`tools/build_mappings.py`)
Evaluates visa requirements against product specs:
- `insurance.mandatory` → NOT_REQUIRED if false
- `insurance.no_deductible` → RED if deductible > 0
- `insurance.min_coverage` → RED if limit < required
- `insurance.monthly_payments_accepted` → RED if monthly and rejected
- `insurance.must_cover_full_period` → YELLOW for monthly subscriptions

### UI (`ui/index.html`)
Single-page compliance checker. ASCII-only. Uses `escapeHtml()` for text, `sanitizeUrl()` for links.

## Naming Conventions

- **IDs:** `{COUNTRY}_{VISA}_{AUTHORITY}_{YEAR}` (e.g., `ES_DNV_BLS_LONDON_2026`)
- **JSON keys:** snake_case
- **JS:** camelCase functions/vars, UPPER_SNAKE_CASE constants
- **Commits:** `feat:`, `fix:`, `test:`, `docs:`, `ci:`, `security:`

## Content Linting Rules

Blog posts in `content/{posts,visas,guides,traps}/` must include:
- "what the authority requires"
- "how we evaluate"
- "check in the engine"
- "disclaimer"
- "affiliate disclosure"
- `snapshot=` in deep links

Banned words in content and offers: best, recommend, guarantee, 100%, approved, surely

## Validation Requirements

Product evidence must reference valid sources with:
1. `source_id` in evidence array
2. Corresponding `*.meta.json` in `sources/`
3. `sha256` matching actual file content
4. `local_path` pointing to existing file

## Do Not Commit

- `static/` (generated by sync_hugo_static.py)
- `data/snapshots/` (generated)
- `tools/logs/`
