name: Source Monitor PR

on:
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Check sources
        run: python tools/check_source_changes.py --output tools/source_monitor_report.json --write-status data/source_status.json --report-md tools/source_monitor_report.md
      - name: Detect changes
        id: detect
        run: |
          python - <<'PY'
          import json, os
          with open('tools/source_monitor_report.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          changed = len(data.get('changed', [])) > 0
          with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as out:
              out.write(f"changed={str(changed).lower()}
")
          PY
      - name: Create issue
        if: steps.detect.outputs.changed == 'true'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "Source changes detected"
          content-filepath: tools/source_monitor_report.md
          labels: needs-review
      - name: Create PR
        if: steps.detect.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update source status"
          title: "chore: update source status"
          body: "Automated source monitor status update."
          branch: "bot/source-status"
          add-paths: |
            data/source_status.json
